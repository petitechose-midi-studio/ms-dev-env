name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v0.1.0)"
        required: true
        type: string
      title:
        description: "Release title (optional)"
        required: false
        type: string

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    name: build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            build_native: true
            build_wasm: true
          - os: windows-latest
            build_native: true
            build_wasm: false
          - os: macos-latest
            build_native: true
            build_wasm: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux system deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libsdl2-dev libasound2-dev libudev-dev libusb-1.0-0-dev

      - name: Sync Python deps
        run: uv sync --frozen --extra dev

      - name: Setup workspace (real)
        run: uv run ms setup --skip-prereqs --yes

      - name: Build midi-studio-loader (rust)
        run: cargo build --release
        working-directory: midi-studio/loader

      - name: Build core (teensy)
        run: uv run ms build core --target teensy --env dev

      - name: Build bitwig (teensy)
        run: uv run ms build bitwig --target teensy --env dev

      - name: Build core (native)
        if: ${{ matrix.build_native }}
        run: uv run ms build core --target native

      - name: Build bitwig (native)
        if: ${{ matrix.build_native }}
        run: uv run ms build bitwig --target native

      - name: Build bitwig extension
        if: runner.os == 'Linux'
        run: uv run ms build bitwig --target extension --extensions-dir _bitwig_extensions

      - name: Build core (wasm)
        if: ${{ matrix.build_wasm }}
        run: uv run ms build core --target wasm

      - name: Build bitwig (wasm)
        if: ${{ matrix.build_wasm }}
        run: uv run ms build bitwig --target wasm

      - name: Package dist assets
        if: runner.os == 'Linux'
        run: uv run ms dist package --out dist --require-uploader --wasm --extension --firmware

      - name: Package dist assets
        if: runner.os != 'Linux'
        run: uv run ms dist package --out dist --require-uploader

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ runner.os }}
          path: |
            dist

      - name: Upload repos lock (for manifest)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: repos-lock
          path: |
            .ms/repos.lock.json

  publish:
    name: publish release
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Download dist artifacts (linux)
        uses: actions/download-artifact@v4
        with:
          name: dist-Linux
          path: _dist/dist-Linux

      - name: Download dist artifacts (windows)
        uses: actions/download-artifact@v4
        with:
          name: dist-Windows
          path: _dist/dist-Windows

      - name: Download dist artifacts (macos)
        uses: actions/download-artifact@v4
        with:
          name: dist-macOS
          path: _dist/dist-macOS

      - name: Download repos lock
        uses: actions/download-artifact@v4
        with:
          name: repos-lock
          path: _lock

      - name: Prepare manifest inputs
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist
          python - <<'PY'
          import shutil
          from pathlib import Path

          src_root = Path('_dist')
          dst = Path('dist')
          for p in src_root.rglob('*.zip'):
              shutil.copy2(p, dst / p.name)
          PY
          mkdir -p .ms
          cp _lock/repos.lock.json .ms/repos.lock.json

      - name: Generate manifest.json
        env:
          TAG: ${{ inputs.tag }}
        run: |
          python - <<'PY'
          import os
          from pathlib import Path
          from ms.services.dist import generate_manifest

          tag = os.environ['TAG']
          generate_manifest(
              workspace_root=Path.cwd(),
              dist_dir=Path('dist'),
              channel='release',
              tag=tag,
              out_path=Path('dist/manifest.json'),
          )
          PY

      - name: Publish GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.tag }}
          TITLE: ${{ inputs.title }}
        run: |
          set -euo pipefail
          if [ -n "${TITLE}" ]; then
            REL_TITLE="${TITLE}"
          else
            REL_TITLE="${TAG}"
          fi

          gh release create "$TAG" --title "$REL_TITLE" --notes "See manifest.json in assets." \
            dist/*.zip dist/manifest.json
